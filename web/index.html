<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Camera Monitor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”’ Security Camera Monitor</h1>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Initializing...</span>
            </div>
        </header>

        <!-- Main Controls -->
        <section class="controls-section">
            <h2>System Controls</h2>
            <div class="button-row">
                <button id="startMonitoring" class="btn btn-success">â–¶ Start Monitoring</button>
                <button id="stopMonitoring" class="btn btn-danger" disabled>â¹ Stop Monitoring</button>
                <button id="takeSnapshot" class="btn btn-primary">ğŸ“¸ Take Snapshot</button>
            </div>
        </section>

        <!-- Status Display -->
        <section class="status-section">
            <h2>Current Status</h2>
            <div class="info-grid">
                <div class="info-card">
                    <span class="info-label">Monitoring:</span>
                    <span id="monitoringStatus" class="info-value">â€”</span>
                </div>
                <div class="info-card">
                    <span class="info-label">Capturing:</span>
                    <span id="capturingStatus" class="info-value">â€”</span>
                </div>
                <div class="info-card">
                    <span class="info-label">Motion Detected:</span>
                    <span id="motionStatus" class="info-value">â€”</span>
                </div>
                <div class="info-card">
                    <span class="info-label">Last Motion:</span>
                    <span id="lastMotion" class="info-value">â€”</span>
                </div>
            </div>
        </section>

        <!-- Configuration -->
        <section class="config-section">
            <h2>âš™ï¸ Settings</h2>

            <!-- Camera Settings -->
            <div class="camera-settings-group">
                <h3>ğŸ“· Camera Settings</h3>
                <button id="openCameraSettings" class="btn btn-primary">âš™ï¸ Adjust Camera Settings</button>
            </div>

            <!-- Motion Detection Settings -->
            <div class="settings-grid">
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="captureOnMotion" />
                        Capture Stills on Motion
                    </label>
                </div>

                <div class="setting-group">
                    <label for="motionThreshold">Motion Threshold (pixels):</label>
                    <input type="number" id="motionThreshold" min="100" max="5000" step="100" />
                </div>

                <div class="setting-group">
                    <label for="motionSensitivity">Motion Sensitivity (0-255):</label>
                    <input type="number" id="motionSensitivity" min="1" max="255" />
                </div>

                <div class="setting-group">
                    <label for="burstCount">Burst Count (stills per event):</label>
                    <input type="number" id="burstCount" min="1" max="15" step="1" />
                </div>

                <div class="setting-group">
                    <label for="burstInterval">Burst Interval (seconds):</label>
                    <input type="number" id="burstInterval" min="0.1" max="3" step="0.1" />
                </div>

                <div class="setting-group">
                    <label for="cooldownSeconds">Cooldown Between Bursts (seconds):</label>
                    <input type="number" id="cooldownSeconds" min="1" max="60" step="1" />
                </div>

                <div class="setting-group">
                    <button id="saveConfig" class="btn btn-primary">ğŸ’¾ Save Settings</button>
                    <button id="refreshConfig" class="btn btn-secondary" style="margin-left:8px">ğŸ”„ Refresh Settings</button>
                </div>
            </div>
        </section>

        <!-- Recent Motion Events -->
        <section class="events-section">
            <h2>ğŸ“‹ Recent Motion Events</h2>
            <div class="events-header">
                <button id="refreshEvents" class="btn btn-secondary">ğŸ”„ Refresh</button>
                <span id="eventsCount">0 events</span>
            </div>
            <div id="eventsList" class="events-list">
                <p class="no-data">No motion events recorded</p>
            </div>
        </section>

        <!-- Stills Gallery -->
        <section class="stills-section">
            <h2>ğŸ“· Captured Stills</h2>
            <div class="stills-header">
                <button id="refreshStills" class="btn btn-secondary">ğŸ”„ Refresh</button>
                <button id="deleteAllStills" class="btn btn-danger">ğŸ—‘ Delete All</button>
                <span id="stillsCount">0 stills</span>
            </div>
            <div id="stillsList" class="stills-grid">
                <p class="no-data">No stills captured</p>
            </div>
        </section>

        <!-- Detection Regions -->
        <section class="regions-section">
            <h2>ğŸ¯ Detection Regions</h2>
            <div class="regions-controls">
                <button id="drawRegions" class="btn btn-primary">âœï¸ Draw Detection Zones</button>
                <button id="clearRegions" class="btn btn-danger">ğŸ—‘ Clear All Zones</button>
                <label class="detection-mode-label">
                    <input type="checkbox" id="useRegions" />
                    Use Region-Based Detection
                </label>
                <span id="regionsCount">0 regions defined</span>
            </div>
        </section>

        <!-- Calibration Regions -->
        <section class="regions-section">
            <h2>ğŸ”† Calibration Regions</h2>
            <div class="regions-controls">
                <button id="drawCalibrationRegions" class="btn btn-info">âœï¸ Draw Calibration Zones</button>
                <button id="clearCalibrationRegions" class="btn btn-danger">ğŸ—‘ Clear All Zones</button>
                <label>
                    <input type="checkbox" id="useCalibrationRegions" />
                    Use Calibration Regions
                </label>
                <span id="calibrationRegionsCount">0 regions defined</span>
            </div>
            <p class="info-text" style="margin-top: 0.5rem; color: #a0aec0; font-size: 0.9rem;">Calibration regions exclude areas (like sky) from brightness measurements for better auto-exposure.</p>
        </section>

        <!-- Corner Detection Zones -->
        <section class="zones-section">
            <h2>ğŸš¦ Corner Detection Zones</h2>
            <div class="zones-controls">
                <button id="drawCornerZones" class="btn btn-warning">âœï¸ Define Aâ†’Bâ†’C Zones</button>
                <button id="clearCornerZones" class="btn btn-danger">ğŸ—‘ Clear All Zones</button>
                <label class="detection-mode-label">
                    <input type="checkbox" id="zoneDetectionEnabled" />
                    Use Corner Detection Mode
                </label>
            </div>
            <div class="zones-status">
                <div class="zone-indicator">
                    <span class="zone-badge zone-a" id="zoneABadge">A</span>
                    <span id="zoneAStatus">Not defined</span>
                </div>
                <div class="zone-indicator">
                    <span class="zone-badge zone-b" id="zoneBBadge">B</span>
                    <span id="zoneBStatus">Not defined</span>
                </div>
                <div class="zone-indicator">
                    <span class="zone-badge zone-c" id="zoneCBadge">C</span>
                    <span id="zoneCStatus">Not defined</span>
                </div>
            </div>
            <div class="zones-settings">
                <label for="zoneFrameInterval">Frame Interval (seconds):</label>
                <input type="number" id="zoneFrameInterval" min="0.1" max="0.5" step="0.05" value="0.15" style="width: 80px;" />
                <label for="zoneCycleDuration" style="margin-left: 1rem;">Cycle Duration (seconds):</label>
                <input type="number" id="zoneCycleDuration" min="3" max="10" step="0.5" value="5.0" style="width: 80px;" />
            </div>
            <p class="info-text" style="margin-top: 0.5rem; color: #a0aec0; font-size: 0.9rem;">
                Define 3 zones for corner tracking: Motion starts in Zone A, if it reaches Zone B but NOT Zone C within 5 seconds, a "corner" picture is saved.
            </p>
            <div class="zone-live-status" id="zoneLiveStatus" style="display:none; margin-top: 1rem; padding: 0.75rem; background: #1a202c; border-radius: 4px;">
                <h4 style="margin: 0 0 0.5rem 0;">Live Detection Status</h4>
                <div class="zone-status-grid">
                    <div class="zone-status-item">
                        <span class="zone-status-label">Zone A:</span>
                        <span id="zoneATagged" class="zone-status-value">â€”</span>
                    </div>
                    <div class="zone-status-item">
                        <span class="zone-status-label">Zone B:</span>
                        <span id="zoneBTagged" class="zone-status-value">â€”</span>
                    </div>
                    <div class="zone-status-item">
                        <span class="zone-status-label">Zone C:</span>
                        <span id="zoneCTagged" class="zone-status-value">â€”</span>
                    </div>
                    <div class="zone-status-item">
                        <span class="zone-status-label">Cycle:</span>
                        <span id="zoneCycleStatus" class="zone-status-value">â€”</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Region Drawing Modal -->
    <div id="regionModal" class="modal">
        <div class="modal-content">
            <h2 id="regionModalTitle">ğŸ¯ Detection Regions</h2>
            <p id="regionModalDesc">Click and drag on the image to draw detection regions. Motion will only be detected inside these zones.</p>
            <div class="region-mode-toggle">
                <button id="btnDetectionMode" class="mode-btn active">ğŸ¯ Motion Detection</button>
                <button id="btnCalibrationMode" class="mode-btn">ğŸ”† Auto-Calibration</button>
            </div>
            <div class="modal-body">
                <div class="canvas-container">
                    <canvas id="regionCanvas"></canvas>
                </div>
                <div class="regions-list-panel">
                    <h3>Regions (<span id="modalRegionsCount">0</span>)</h3>
                    <div id="regionsList"></div>
                    <button id="deleteSelected" class="btn btn-danger btn-small" style="display:none">ğŸ—‘ Delete Selected</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="saveRegions" class="btn btn-success">âœ“ Save Regions</button>
                <button id="cancelRegions" class="btn btn-secondary">âœ— Cancel</button>
            </div>
        </div>
    </div>

    <!-- Corner Zone Drawing Modal -->
    <div id="cornerZoneModal" class="modal">
        <div class="modal-content">
            <h2>ğŸš¦ Define Corner Detection Zones</h2>
            <p>Draw three zones in sequence: A (entry), B (corner), C (exit). Click and drag to define each zone.</p>
            <div class="zone-drawing-header">
                <div class="zone-steps">
                    <button id="drawZoneA" class="zone-step-btn active" data-zone="a">
                        <span class="zone-badge zone-a">A</span> Entry Zone
                    </button>
                    <button id="drawZoneB" class="zone-step-btn" data-zone="b">
                        <span class="zone-badge zone-b">B</span> Corner Zone
                    </button>
                    <button id="drawZoneC" class="zone-step-btn" data-zone="c">
                        <span class="zone-badge zone-c">C</span> Exit Zone
                    </button>
                </div>
                <div class="current-zone-indicator">
                    <span>Drawing: </span>
                    <span class="zone-badge" id="currentZoneIndicator">A</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="canvas-container">
                    <canvas id="cornerZoneCanvas"></canvas>
                </div>
                <div class="zones-list-panel">
                    <h3>Defined Zones</h3>
                    <div class="zone-def" id="zoneADef">
                        <span class="zone-badge zone-a">A</span>
                        <span id="zoneACoords">Not defined</span>
                        <button class="btn-clear-zone" data-zone="a">âœ—</button>
                    </div>
                    <div class="zone-def" id="zoneBDef">
                        <span class="zone-badge zone-b">B</span>
                        <span id="zoneBCoords">Not defined</span>
                        <button class="btn-clear-zone" data-zone="b">âœ—</button>
                    </div>
                    <div class="zone-def" id="zoneCDef">
                        <span class="zone-badge zone-c">C</span>
                        <span id="zoneCCoords">Not defined</span>
                        <button class="btn-clear-zone" data-zone="c">âœ—</button>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="saveCornerZones" class="btn btn-success">âœ“ Save Zones</button>
                <button id="cancelCornerZones" class="btn btn-secondary">âœ— Cancel</button>
            </div>
        </div>
    </div>

    <!-- Camera Settings Modal -->
    <div id="cameraModal" class="modal">
        <div class="modal-content camera-modal">
            <h2>ğŸ“· Camera Settings</h2>
            <div class="modal-body">
                <div class="settings-columns">
                    <div class="camera-preview-panel">
                        <h3>Live Preview</h3>
                        <div class="preview-container">
                            <img id="stillPreview" src="/api/frame" alt="Camera Preview" />
                        </div>
                        <p class="preview-info">Pure ISP output â€” what the camera actually captures</p>
                    </div>
                    <div class="camera-controls-panel">
                        <h3>Camera Profile</h3>
                        <p class="auto-mode-note">Profiles are applied automatically based on scene brightness</p>
                        <div class="profile-status">
                            <div class="profile-current">
                                <span class="info-label">Active Profile:</span>
                                <span id="activeProfileName" class="profile-badge">â€”</span>
                            </div>
                            <div class="profile-details" id="profileDetails">
                                <div class="profile-detail-row">
                                    <span class="detail-label">Brightness:</span>
                                    <span id="profileBrightness" class="detail-value">â€”</span>
                                </div>
                                <div class="profile-detail-row">
                                    <span class="detail-label">Contrast:</span>
                                    <span id="profileContrast" class="detail-value">â€”</span>
                                </div>
                                <div class="profile-detail-row">
                                    <span class="detail-label">Saturation:</span>
                                    <span id="profileSaturation" class="detail-value">â€”</span>
                                </div>
                                <div class="profile-detail-row">
                                    <span class="detail-label">Sharpness:</span>
                                    <span id="profileSharpness" class="detail-value">â€”</span>
                                </div>
                                <div class="profile-detail-row">
                                    <span class="detail-label">Noise Reduction:</span>
                                    <span id="profileNR" class="detail-value">â€”</span>
                                </div>
                            </div>
                        </div>
                        <div class="luminance-display" style="margin-top: 1rem; padding: 0.75rem; background: #2d3748; border-radius: 4px;">
                            <div class="profile-detail-row">
                                <span class="detail-label" style="font-weight: bold; color: #ffa500;">Scene Luminance (masked):</span>
                                <span id="sceneLuminance" class="detail-value" style="font-weight: bold; color: #ffa500; font-size: 1.2em;">â€”</span>
                            </div>
                            <div class="profile-detail-row" style="margin-top: 0.25rem;">
                                <span class="detail-label" style="color: #a0aec0;">Luminance (full frame):</span>
                                <span id="sceneLuminanceUnmasked" class="detail-value" style="color: #a0aec0;">â€”</span>
                            </div>
                            <div class="profile-detail-row" style="margin-top: 0.25rem;">
                                <span class="detail-label" style="color: #a0aec0;">Calibration Mask:</span>
                                <span id="maskActiveStatus" class="detail-value" style="color: #a0aec0;">â€”</span>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #a0aec0;">
                                <div>Thresholds: Day Bright â‰¥<span id="thresholdDayBright">â€”</span>, Day â‰¥<span id="thresholdDay">â€”</span>, Dusk Bright â‰¥<span id="thresholdDuskBright">â€”</span>, Dusk Dark â‰¥<span id="thresholdDuskDark">â€”</span></div>
                            </div>
                        </div>
                        <h3 style="margin-top: 1.5rem;">Force Profile</h3>
                        <div class="profile-buttons">
                            <button id="forceDayBright" class="btn btn-profile">â˜€ï¸â˜€ï¸ Day Bright</button>
                            <button id="forceDay" class="btn btn-profile">â˜€ï¸ Day</button>
                            <button id="forceDuskBright" class="btn btn-profile">ğŸŒ¤ï¸ Dusk Bright</button>
                        </div>
                        <div class="profile-buttons" style="margin-top: 8px;">
                            <button id="forceDuskDark" class="btn btn-profile">ğŸŒ… Dusk Dark</button>
                            <button id="forceNight" class="btn btn-profile">ğŸŒ™ Night</button>
                        </div>
                        <p class="preview-info" style="margin-top: 0.5rem;">Forced profile will be overridden at next auto-calibration cycle</p>

                        <!-- Ownership Controls -->
                        <div class="ownership-controls" style="margin-top: 1rem;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="info-label">Config Owner:</span>
                                <span id="ownerStatus" class="detail-value">â€”</span>
                            </div>
                            <div style="margin-top:0.5rem; display:flex; gap:8px;">
                                <button id="claimOwner" class="btn btn-secondary btn-small">â• Claim</button>
                                <button id="releaseOwner" class="btn btn-secondary btn-small">â– Release</button>
                                <button id="hardRefresh" class="btn btn-secondary btn-small">ğŸ” Hard Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="calibrateNow" class="btn btn-info">âš™ Recalibrate Now</button>
                <button id="closeCameraSettings" class="btn btn-secondary">âœ“ Close</button>
            </div>
        </div>
    </div>

    <!-- Still Lightbox -->
    <div id="stillLightbox" class="lightbox" style="display:none">
        <div class="lightbox-overlay" id="lightboxClose"></div>
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="Still" />
            <div class="lightbox-info">
                <span id="lightboxFilename"></span>
                <div class="lightbox-actions">
                    <a id="lightboxDownload" href="" download class="btn btn-primary btn-small">â¬‡ Download</a>
                    <button id="lightboxDelete" class="btn btn-danger btn-small">ğŸ—‘ Delete</button>
                    <button id="lightboxCloseBtn" class="btn btn-secondary btn-small">âœ— Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
